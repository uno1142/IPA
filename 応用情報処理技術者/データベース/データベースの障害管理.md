# データベースの障害回復

データベースは障害の発生に備えて定期的にバックアップを取ることが基本。  
１日に１回などの頻度を決めて、その時点でのデータベース内容を丸ごと別のファイルにコピーして保管する。  

ただし、バックアップのみでは次のバックアップまでの間に更新された内容を保存できない。  
そのため、バックアップ後の更新は「ジャーナル」とよばれるログファイルに更新前の状態(更新前ジャーナル)と  
更新後の状態(更新後ジャーナル)を逐一記録し、更新履歴を管理するようにしている。  

実際に障害が発生した場合は、これらのファイルを使ってロールバックやロールフォワードなどの障害回復処理を行い、以前の状態に復旧する。  


## コミットとロールバック

データベースはトランザクション単位で更新処理を管理する。  
すなわち「トランザクション内の更新すべてを反映する」か「トランザクション内の更新すべてを取り消す」かのどちらかしかない。  

トランザクションは、一連の処理が問題なく完了できたとき、最後にその更新を確定することでデータベースへと更新内容を反映させる。  
これをコミットと呼ぶ。(Git-commitはコレ！)

一方、トランザクション処理中になんらかの障害が発生して更新に失敗した場合、そこまでに行った処理はすべてなかったことにしなければならない。  
この場合は、データベース更新前の状態を更新前ジャーナルから取得し、データベースをトランザクション開始直前の状態にまで戻す。  
この処理をロールバックとよぶ。

## ロールフォワード

トランザクションの処理中ではなく、ディスク障害などで突然データベースが故障してしまった場合は、定期的に保存してある  
バックアップファイルからデータを復元する必要が出てくる。  

しかしそれだけではバックアップ後に更新された変更分は失われたままになってしまう。  
そこで、バックアップ以降の更新後ジャーナルから更新情報を取得し、障害発生直前の状態にまで復元させる。  
これをロールフォワードと呼ぶ。  


## チェックポイント

DBMSの中には、処理効率向上のために更新データをすぐには補助記憶装置へと書き出さず、主記憶装置上のバッファに保持するものがある。  
※データベースを更新すると処理がおそいが、バッファを更新するだけなら変更のあったブロックが書き換えられるだけなので処理が早い。  

>buffer memory。 バッファの語意は「緩衝装置」。 パソコンやデジタルカメラがデータ処理する上で、一時的にデータを溜めておく場所をバッファメモリと言う。 メモリーカード やプリンタなど周辺機器の処理速度に合わせてデータを安定供給するために利用される。

このようなバッファ内のデータは、一定の間隔で補助記憶装置側のデータベースへと反映される。  
この反映を行うイベントのことをチェックポイントと呼ぶ。  

## 分散データベースと２相コミット

物理的に分かれている複数のデータベースを、見かけ上ひとつのデータベースとして扱えるようにしたシステムを「分散データベースシステム」と呼ぶ。  

このような分散データベースでは、トランザクション処理が各サイトにわたって行われるため、全体の同期をとってコミットやロールバックを行う必要がある。  
そのため、まず全サイトに対して「コミットできる？」という問い合わせを行い、その結果を見てコミットやロールバックを行う。  
この方式を２相コミットと呼ぶ。  


